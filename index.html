<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Pixel Art Shooting (Launcher + Enemies)</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
    .center{height:100%;display:grid;place-items:center}
    button{font:700 18px/1.1 system-ui;padding:14px 24px;border:0;border-radius:14px;background:#10b981;color:#001;box-shadow:0 6px 20px #0008}
    button:active{transform:translateY(1px)}
    iframe{position:fixed;inset:0;width:100%;height:100%;border:0;background:#000}
    .hint{position:fixed;left:0;right:0;bottom:10px;text-align:center;font-size:12px;color:#9aa}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="center" id="launcher">
    <div>
      <h1 style="margin:0 0 16px;font-size:22px;text-align:center">Pixel Art Shooting</h1>
      <button id="play">Play</button>
      <div class="hint">画像は <code>enemy0.png</code>, <code>enemy1.png</code> … をリポジトリ直下に置いてください</div>
    </div>
  </div>

  <script>
  // ====== ★ゲーム本体（base64埋め込み）★ ======
  const H = "PGh0bWw+PG1ldGEgY2hhcnNldD11dGYtOD48bWV0YSBuYW1lPXZpZXdwb3J0IGNvbnRlbnQ9d2lkdGg9ZGV2aWNlLXdpZHRoLGluaXRpYWwtc2NhbGU9MT48c3R5bGU+Cmh0bWwsYm9keXttYXJnaW46MDtiYWNrZ3JvdW5kOiMwMDA7aGVpZ2h0OjEwMCU7ZGlzcGxheTpncmlkO3BsYWNlLWl0ZW1zOmNlbnRlcn0jY3tkaXNwbGF5OmJsb2NrO3RvdWNoLWFjdGlvbjpub25lO2ltYWdlLXJlbmRlcmluZzpwaXhlbGF0ZWR9Cjwvc3R5bGU+PGNhbnZhcyBpZD1jPjwvY2FudmFzPjxzY3JpcHQ+CmxldCBjPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjJykseD1jLmdldENvbnRleHQoJzJkJyx7YWxwaGE6ZmFsc2V9KSxXPTE2MCxIPTI0MDsKbGV0IFA9e3g6NzIseToyMDgsdzoxNixoOjE2LHY6Mn0sRT1bXSxvPTAsdHg9ODAsYT0xLFM9MCxpbT1uZXcgSW1hZ2UoKTtpbS5zcmM9ImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQkFBQUFBUUNBWUFBQUFmOC85aEFBQUFBWE5TUjBJQXJzNGM2UUFBQVFSSlJFRlVPSTN0a0R0T3cxQVFSWStoUTdpSTA1Q1BrRkxZUlVTTktIQVJCYkVGVjZ3aEJSdElGaENsZFpjTnNBdFRJSkJZZ0MzaGlwZ0dHenRCSURlUHd0K1hqOUpTWktTbnVYUDE1czdNaFVQOHN4aGtTUUNpclY5c3hZTTlHc0lCTWJ3YkNmSmN4MDR1VW04NExwSGFoVFFabjV5ZTgzcW0walQ2ekI3bWZMd0ZmTjNlRVA4bS9DeStlVWxqVUxzVDBnUUFCUUROZ05BVlhON0Q5UlUwV3RXSUtNanFLTWpxeHlkNG5vSm1LSVJ1TGdCeWN4VEErNmQ4WEtkWjRVSUVsS09TN09tN20wSG1ldnFtZVZoMjNTUlJjRmkyeERrRm41dFpiZUI3bUpZTmdMTVVxL1VKQldkYU52aGV5VythdUdVOUtYeFBNckVLellEMUUzYTk3QzhBZnpCQmZCWmIzc2RUQUFBQUFFbEZUa1N1UW1DQyI7CmZ1bmN0aW9uIHN6KCl7bGV0IGQ9ZGV2aWNlUGl4ZWxSYXRpb3x8MSxtdz1pbm5lcldpZHRoKi45NixtaD1pbm5lckhlaWdodCouOTYsYXI9SC9XLHc9TWF0aC5taW4obXcsbWgvYXIpfDAsaD0odyphcil8MDsKICBjLnN0eWxlLndpZHRoPXcrJ3B4JzsgYy5zdHlsZS5oZWlnaHQ9aCsncHgnOyBjLndpZHRoPSh3KmQpfDA7IGMuaGVpZ2h0PShoKmQpfDA7CiAgeC5zZXRUcmFuc2Zvcm0oKHcqZCkvVywwLDAsKGgqZCkvSCwwLDApOyB4LmltYWdlU21vb3RoaW5nRW5hYmxlZD1mYWxzZX1hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLHN6KTsgc3ooKTsKZnVuY3Rpb24gUihBLEIpe3JldHVybiBNYXRoLnJhbmRvbSgpKihCLUEpK0F9ZnVuY3Rpb24gRihhLGIsdyxoLGNvKXt4LmZpbGxTdHlsZT1jbzt4LmZpbGxSZWN0KGEsYix3LGgpfWZ1bmN0aW9uIHNwKCl7RS5wdXNoKHt4OlIoMCxXLTEwKSx5Oi0xMix3OjEwLGg6MTAsdjpSKDEuMSwyLjMpfSl9CmZ1bmN0aW9uIHN0ZXAoKXtpZihvKyslMjI9PTApc3AoKTtFLmZvckVhY2goZT0+e2UueSs9ZS52O0YoZS54LGUueSxlLncsZS5oLCcjZjMzJyl9KTtFPUUuZmlsdGVyKGU9PmUueTxIKzIwKTtsZXQgZHg9dHgtUC54O1AueCs9TWF0aC5zaWduKGR4KSpNYXRoLm1pbihNYXRoLmFicyhkeCksUC52KTtQLng9TWF0aC5tYXgoMCxNYXRoLm1pbihXLVAudyxQLngpKTtpZihpbS5jb21wbGV0ZSl4LmRyYXdJbWFnZShpbSxQLngsUC55LFAudyxQLmgpO2Vsc2UgRihQLngsUC55LFAudyxQLmgsJyMzZjMnKTtFLmZvckVhY2goZT0+e2lmKGUueDxQLngrUC53JiZlLngrZS53PlAueCYmZS55PFAueStQLmgmJmUueStlLmg+UC55KWE9MH0pO1MrK30KZnVuY3Rpb24gaHVkKCl7eC5maWxsU3R5bGU9JyNmZmYnO3guZm9udD0nMTBweCBtb25vc3BhY2UnO3guZmlsbFRleHQoJ1M6JytTLDQsMTApO2lmKCFhKXguZmlsbFRleHQoJ0dhbWUgT3ZlciAoVGFwKScsMzAsMTIwKX0KZnVuY3Rpb24gbG9vcCgpe3guZmlsbFN0eWxlPScjMDAwJzt4LmZpbGxSZWN0KDAsMCxXLEgpO2lmKGEpc3RlcCgpO2h1ZCgpO3JlcXVlc3RBbmltYXRpb25GcmFtZShsb29wKX07bG9vcCgpOwpmdW5jdGlvbiBwb3MoZSl7bGV0IHI9Yy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtyZXR1cm4gKGUuY2xpZW50WC1yLmxlZnQpL3Iud2lkdGgqV31mdW5jdGlvbiBycygpe2E9MTtFPVtdO1M9MDtQLng9NzI7dHg9ODA7bz0wfQpjLm9ucG9pbnRlcmRvd249ZT0+e2lmKCFhKXJzKCk7dHg9cG9zKGUpfTsgYy5vbnBvaW50ZXJtb3ZlPWU9PnR4PXBvcyhlKTsKYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsZT0+e2lmKCFhKXJzKCk7aWYoZS5rZXk9PSdBcnJvd0xlZnQnKXR4LT0yMDtlbHNlIGlmKGUua2V5PT0nQXJyb3dSaWdodCcpdHgrPTIwfSk7Cjwvc2NyaXB0PjwvaHRtbD4=";

  // ====== 敵パッチ（16×16）を末尾に差し込む ======
  function addEnemyPatch(html){
    const patch = `
<!-- === ARTA enemy sprite patch (16x16対応) === -->
<script>
(function(){
  const spriteNames = [
    "enemy0.png","enemy1.png","enemy2.png","enemy3.png","enemy4.png",
    "enemy5.png","enemy6.png","enemy7.png","enemy8.png","enemy9.png",
    "enemy10.png","enemy11.png","enemy12.png","enemy13.png","enemy14.png",
    "enemy15.png","enemy16.png","enemy17.png","enemy18.png","enemy19.png"
  ];
  const sprites = [];
  spriteNames.forEach(n=>{ const img=new Image(); img.onload=()=>sprites.push(img); img.src=n; });

  const choiceCache = new Map();
  function pickSprite(x,y,w,h){
    if(!sprites.length) return null;
    const xi=Math.round(x/4), yi=Math.round(y/4); // 動いても同じ見た目に
    const key=xi+"|"+yi+"|"+w+"|"+h;
    if(choiceCache.has(key)) return sprites[choiceCache.get(key)]||null;
    let n=(xi*73856093 ^ yi*19349663 ^ w*83492791 ^ h*2654435761)>>>0;
    const idx=n%sprites.length; choiceCache.set(key,idx);
    return sprites[idx]||null;
  }

  try{
    const p=CanvasRenderingContext2D.prototype;
    if(!p.__altaEnemy16){
      const orig=p.fillRect;
      p.fillRect=function(x,y,w,h){
        const isSquare=Math.abs(w-h)<=2;
        const near16=(w>=14&&w<=18)&&(h>=14&&h<=18);
        if(isSquare&&near16){
          const img=pickSprite(x,y,w,h);
          if(img && img.complete){ try{ this.drawImage(img,x,y,w,h); return; }catch(e){} }
        }
        return orig.call(this,x,y,w,h);
      };
      p.__altaEnemy16=true;
    }
  }catch(e){}
})();
</script>
<!-- === /ARTA enemy sprite patch === -->
`;
    return html.includes("</body>") ? html.replace("</body>", patch + "\n</body>") : (html + patch);
  }

  // ====== Playを押したら srcdoc で起動 ======
  document.getElementById('play').addEventListener('click', () => {
    try{
      const raw = atob(H);
      const patched = addEnemyPatch(raw);
      const iframe = document.createElement('iframe');
      iframe.setAttribute('allow', 'autoplay; fullscreen');
      iframe.srcdoc = patched;               // 画像は相対パス（enemy*.png）で読める
      document.body.appendChild(iframe);
      document.getElementById('launcher').classList.add('hide');
    }catch(e){
      alert('起動に失敗しました。ブラウザを更新してもう一度お試しください。');
      console.error(e);
    }
  });
  </script>
</body>
</html>
